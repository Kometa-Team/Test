name: Labeled

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

jobs:

  validate-pull:
    runs-on: ubuntu-latest
    #if: github.event.label.name == 'tester' # github.event.action == 'labeled' &&
    steps:

      - name: Display Refs
        id: refs
        run: |
          echo "Base Repo: ${{ github.event.pull_request.base.repo.full_name }}"
          echo "Base Ref: ${{ github.base_ref }}"
          echo "Head Repo: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "Head Ref: ${{ github.head_ref }}"
          body="${{ github.event.pull_request.body }}"
          #echo "Body 1: $body"
          body=$(echo "$body" | sed -n '/## Description/,/## Issues Fixed or Closed/{/## Description/b;/## Issues Fixed or Closed/b;p}')
          #echo "Body 2: $body"
          body=$(echo $body|tr -d '\n')
          #echo "Body 3: $body"
          echo "description=$body" >> $GITHUB_OUTPUT
          

      - name: Discord Notification
        uses: Kometa-Team/discord-notifications@master
        with:
          webhook_id_token: ${{ secrets.BUILD_WEBHOOK }}
          message: "The Kometa team are requesting @Testers to assist with testing an upcoming feature/bug fix.
          
                    * For Local Git pull and checkout the `${{ github.head_ref }}` branch 
                    * For Docker use the `kometateam/kometa:${{ github.head_ref }}` image to do your testing
                    
                    Please report back either here or on the original GitHub Pull Request"
          title: ${{ github.event.pull_request.title }}
          description: ${{ steps.refs.outputs.description }}
          url: https://github.com/Kometa-Team/${{ vars.REPO_NAME }}/pull/${{ github.event.number }}
          color: ${{ vars.COLOR_SUCCESS }}
          username: ${{ vars.BOT_NAME }}
          avatar_url: ${{ vars.BOT_IMAGE }}
          author: ${{ vars.GIT_NAME }}
          author_icon_url: ${{ vars.GIT_IMAGE }}